
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>基于 CoreText 的排版引擎：基础 | 唐巧的博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="唐巧">
    

    
    <meta name="description" content="版权说明原创文章，转载请保留以下信息：

本文节选自我的图书：《iOS 开发进阶 》。
本文涉及的 Demo 工程在这里：https://github.com/tangqiaoboy/iOS-Pro。
扫码关注我的「iOS 开发」微信公众帐号：



本章前言使用 CoreText 技术，我们可以对富文本进行复杂的排版。经过一些简单的扩展，我们还可以实现对于图片，链接的点击效果。CoreText">
<meta property="og:type" content="article">
<meta property="og:title" content="基于 CoreText 的排版引擎：基础">
<meta property="og:url" content="http://blog.devtang.com/2015/06/27/using-coretext-1/index.html">
<meta property="og:site_name" content="唐巧的博客">
<meta property="og:description" content="版权说明原创文章，转载请保留以下信息：

本文节选自我的图书：《iOS 开发进阶 》。
本文涉及的 Demo 工程在这里：https://github.com/tangqiaoboy/iOS-Pro。
扫码关注我的「iOS 开发」微信公众帐号：



本章前言使用 CoreText 技术，我们可以对富文本进行复杂的排版。经过一些简单的扩展，我们还可以实现对于图片，链接的点击效果。CoreText">
<meta property="og:image" content="http://blog.devtang.com/images/weixin-qr.jpg">
<meta property="og:image" content="http://tangqiao.b0.upaiyun.com/coretext/coretext_arch.png">
<meta property="og:image" content="http://tangqiao.b0.upaiyun.com/coretext/coretext-1.png">
<meta property="og:image" content="http://tangqiao.b0.upaiyun.com/coretext/coretext-2.png">
<meta property="og:image" content="http://tangqiao.b0.upaiyun.com/coretext/coretext-3.png">
<meta property="og:image" content="http://tangqiao.b0.upaiyun.com/coretext/coretext-create-ctdisplayview.png">
<meta property="og:image" content="http://tangqiao.b0.upaiyun.com/coretext/coretext-4.png">
<meta property="og:image" content="http://tangqiao.b0.upaiyun.com/coretext/coretext-5.png">
<meta property="og:image" content="http://tangqiao.b0.upaiyun.com/coretext/coretext-flip.png">
<meta property="og:image" content="http://tangqiao.b0.upaiyun.com/coretext/coretext-shape.png">
<meta property="og:image" content="http://tangqiao.b0.upaiyun.com/coretext/coretext-un-select-autolayout.png">
<meta property="og:image" content="http://tangqiao.b0.upaiyun.com/coretext/coretext-uml.png">
<meta property="og:image" content="http://tangqiao.b0.upaiyun.com/coretext/coretext-attribute-string-as-argument.png">
<meta property="og:image" content="http://tangqiao.b0.upaiyun.com/coretext/coretext-load-from-json-template.png">
<meta property="og:updated_time" content="2016-06-19T03:14:33.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="基于 CoreText 的排版引擎：基础">
<meta name="twitter:description" content="版权说明原创文章，转载请保留以下信息：

本文节选自我的图书：《iOS 开发进阶 》。
本文涉及的 Demo 工程在这里：https://github.com/tangqiaoboy/iOS-Pro。
扫码关注我的「iOS 开发」微信公众帐号：



本章前言使用 CoreText 技术，我们可以对富文本进行复杂的排版。经过一些简单的扩展，我们还可以实现对于图片，链接的点击效果。CoreText">
<meta name="twitter:image" content="http://blog.devtang.com/images/weixin-qr.jpg">

    
    <link rel="alternative" href="/atom.xml" title="唐巧的博客" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.png">
    
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="唐巧的博客">唐巧的博客</a></h1>
				<h2 class="blog-motto">记录下自己学习的点滴</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:blog.devtang.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/06/27/using-coretext-1/" title="基于 CoreText 的排版引擎：基础" itemprop="url">基于 CoreText 的排版引擎：基础</a>
  </h1>
  
  <p class="article-time">
    <time datetime="2015-06-27T00:39:56.000Z" itemprop="datePublished"> 发表于 2015-06-27 08:39</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#版权说明"><span class="toc-number">1.</span> <span class="toc-text">版权说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#本章前言"><span class="toc-number">2.</span> <span class="toc-text">本章前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CoreText-简介"><span class="toc-number">3.</span> <span class="toc-text">CoreText 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基于-CoreText-的基础排版引擎"><span class="toc-number">4.</span> <span class="toc-text">基于 CoreText 的基础排版引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#不带图片的排版引擎"><span class="toc-number">4.1.</span> <span class="toc-text">不带图片的排版引擎</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#能输出-Hello-World-的-CoreText-工程"><span class="toc-number">5.</span> <span class="toc-text">能输出 Hello World 的 CoreText 工程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#操作步骤"><span class="toc-number">5.1.</span> <span class="toc-text">操作步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#代码基本的宏定义和-Category"><span class="toc-number">5.1.1.</span> <span class="toc-text">代码基本的宏定义和 Category</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#排版引擎框架"><span class="toc-number">6.</span> <span class="toc-text">排版引擎框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定制排版文件格式"><span class="toc-number">7.</span> <span class="toc-text">定制排版文件格式</span></a></li></ol>
		
		</div>
		
		<h2 id="版权说明"><a href="#版权说明" class="headerlink" title="版权说明"></a>版权说明</h2><p>原创文章，转载请保留以下信息：</p>
<ul>
<li>本文节选自我的图书：《<a href="http://item.jd.com/11598468.html" target="_blank">iOS 开发进阶 </a>》。</li>
<li>本文涉及的 Demo 工程在这里：<a href="https://github.com/tangqiaoboy/iOS-Pro" target="_blank" rel="external">https://github.com/tangqiaoboy/iOS-Pro</a>。</li>
<li><p>扫码关注我的「iOS 开发」微信公众帐号：</p>
<p><img src="http://blog.devtang.com/images/weixin-qr.jpg" alt="二维码"></p>
</li>
</ul>
<h2 id="本章前言"><a href="#本章前言" class="headerlink" title="本章前言"></a>本章前言</h2><p>使用 CoreText 技术，我们可以对富文本进行复杂的排版。经过一些简单的扩展，我们还可以实现对于图片，链接的点击效果。CoreText 技术相对于 UIWebView，有着更少的内存占用，以及可以在后台渲染的优点，非常适合用于内容的排版工作。</p>
<p>本章我们将从最基本的开始，一步一步完成一个支持图文混排、支持图片和链接点击的排版引擎。</p>
<h2 id="CoreText-简介"><a href="#CoreText-简介" class="headerlink" title="CoreText 简介"></a>CoreText 简介</h2><p>CoreText 是用于处理文字和字体的底层技术。它直接和 Core Graphics（又被称为 Quartz）打交道。Quartz 是一个 2D 图形渲染引擎，能够处理 OSX 和 iOS 中的图形显示。</p>
<p>Quartz 能够直接处理字体（font）和字形（glyphs），将文字渲染到界面上，它是基础库中唯一能够处理字形的模块。因此，CoreText 为了排版，需要将显示的文本内容、位置、字体、字形直接传递给 Quartz。相比其它 UI 组件，由于 CoreText 直接和 Quartz 来交互，所以它具有高速的排版效果。</p>
<p>下图是 CoreText 的架构图，可以看到，CoreText 处于非常底层的位置，上层的 UI 控件（包括 UILabel，UITextField 以及 UITextView）和 UIWebView 都是基于 CoreText 来实现的。</p>
<blockquote>
<p>注意：这个是 iOS7 之后的架构图，在 iOS7 以前，并没有图中的 Text Kit 类，不过 CoreText 仍然是处在最底层直接和 Core Graphics 打交道的模块。</p>
</blockquote>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext_arch.png" alt="CoreText 的架构图"></p>
<p>UIWebView 也是处理复杂的文字排版的备选方案。对于排版，基于 CoreText 和基于 UIWebView 相比，前者有以下好处：</p>
<ul>
<li>CoreText 占用的内存更少，渲染速度快，UIWebView 占用的内存更多，渲染速度慢。</li>
<li>CoreText 在渲染界面前就可以精确地获得显示内容的高度（只要有了 CTFrame 即可），而 UIWebView 只有渲染出内容后，才能获得内容的高度（而且还需要用 javascript 代码来获取）</li>
<li>CoreText 的 CTFrame 可以在后台线程渲染，UIWebView 的内容只能在主线程（UI 线程）渲染。</li>
<li>基于 CoreText 可以做更好的原生交互效果，交互效果可以更细腻。而 UIWebView 的交互效果都是用 javascript 来实现的，在交互效果上会有一些卡顿存在。例如，在 UIWebView 下，一个简单的按钮按下效果，都无法做到原生按钮的即时和细腻的按下效果。</li>
</ul>
<p>当然，基于 CoreText 的排版方案也有一些劣势：</p>
<ul>
<li>CoreText 渲染出来的内容不能像 UIWebView 那样方便地支持内容的复制。</li>
<li>基于 CoreText 来排版需要自己处理很多复杂逻辑，例如需要自己处理图片与文字混排相关的逻辑，也需要自己实现链接点击操作的支持。</li>
</ul>
<p>在业界，很多应用都采用了基于 CoreText 技术的排版方案，例如：新浪微博客户端，多看阅读客户端。我所在的创业公司的猿题库，也使用了自己基于 CoreText 技术实现的排版引擎，下图是我们产品的一个图文混排的界面（其中所有公式都是用图片的方式呈现的），可以看到，图片和文字排版效果很好。</p>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-1.png" alt="猿题库的采用 CoreText 渲染的界面"></p>
<h2 id="基于-CoreText-的基础排版引擎"><a href="#基于-CoreText-的基础排版引擎" class="headerlink" title="基于 CoreText 的基础排版引擎"></a>基于 CoreText 的基础排版引擎</h2><h3 id="不带图片的排版引擎"><a href="#不带图片的排版引擎" class="headerlink" title="不带图片的排版引擎"></a>不带图片的排版引擎</h3><p>下面我们来尝试完成一个基于 CoreText 的排版引擎。我们将从最简单的排版功能开始，然后逐步支持图文混排，链接点击等功能。</p>
<p>首先我们来尝试完成一个不支持图片内容的纯文字排版引擎。</p>
<p>注意 1：由于整个排版引擎的代码太多，为方便读者阅读，文章中只会列出最关键的核心代码，完整的代码请参考本书对应的 github 项目，项目地址是：<a href="https://github.com/tangqiaoboy/iOS-Pro" target="_blank" rel="external">https://github.com/tangqiaoboy/iOS-Pro</a> 。</p>
<h2 id="能输出-Hello-World-的-CoreText-工程"><a href="#能输出-Hello-World-的-CoreText-工程" class="headerlink" title="能输出 Hello World 的 CoreText 工程"></a>能输出 Hello World 的 CoreText 工程</h2><h3 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h3><p>我们首先新建一个 Xcode 工程，步骤如下：</p>
<ol>
<li>打开 Xcode，选择 “File”-&gt;”New”-&gt;”Project”, 在弹出的对话框中，选择 “Single View Application”，然后点击 “Next”。（图 2）</li>
<li>接着填上项目名 CoreTextDemo，然后点击 “Next”。（图 3）</li>
<li><p>选择保存目录后，我们就成功创建了一个空的工程。</p>
<p>图 2<br><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-2.png" alt="图 2"></p>
<p>图 3<br><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-3.png" alt="图 3"></p>
</li>
</ol>
<p>在工程目录 “CoreTextDemo” 上右击，选择 “New File”, 然后填入类名<code>CTDisplayView</code>, 并且让它的父类是 UIView。（如下图）</p>
<p> <img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-create-ctdisplayview.png" alt=""></p>
<p>接着，我们在<code>CTDisplayView.m</code>文件中，让其 import 头文件<code>CoreText/CoreText.h</code>，接着输入以下代码来实现其<code>drawRect</code>方法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#import &quot;CTDisplayView.h&quot;</div><div class="line">#import &quot;CoreText/CoreText.h&quot;</div><div class="line"></div><div class="line">@implementation CTDisplayView</div><div class="line"></div><div class="line">- (void)drawRect:(CGRect)rect</div><div class="line">&#123;</div><div class="line">    [super drawRect:rect];</div><div class="line"></div><div class="line">    // 步骤 1</div><div class="line">    CGContextRef context = UIGraphicsGetCurrentContext();</div><div class="line"></div><div class="line">    // 步骤 2</div><div class="line">    CGContextSetTextMatrix(context, CGAffineTransformIdentity);</div><div class="line">    CGContextTranslateCTM(context, 0, self.bounds.size.height);</div><div class="line">    CGContextScaleCTM(context, 1.0, -1.0);</div><div class="line"></div><div class="line">    // 步骤 3</div><div class="line">    CGMutablePathRef path = CGPathCreateMutable();</div><div class="line">    CGPathAddRect(path, NULL, self.bounds);</div><div class="line"></div><div class="line">    // 步骤 4</div><div class="line">    NSAttributedString *attString = [[NSAttributedString alloc] initWithString:@&quot;Hello World!&quot;];</div><div class="line">    CTFramesetterRef framesetter =</div><div class="line">    CTFramesetterCreateWithAttributedString((CFAttributedStringRef)attString);</div><div class="line">    CTFrameRef frame =</div><div class="line">    CTFramesetterCreateFrame(framesetter,</div><div class="line">                             CFRangeMake(0, [attString length]), path, NULL);</div><div class="line"></div><div class="line">    // 步骤 5</div><div class="line">    CTFrameDraw(frame, context);</div><div class="line"></div><div class="line">    // 步骤 6</div><div class="line">    CFRelease(frame);</div><div class="line">    CFRelease(path);</div><div class="line">    CFRelease(framesetter);</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>打开程序的 Storyboard 文件：<code>Main_iPhone.storyboard</code>：执行下面 2 步：</p>
<ol>
<li>将一个 UIView 控件拖动到主界面正中间。（如下图步骤 1）</li>
<li>将该 UIView 控件的类名从<code>UIView</code>修改为<code>CTDisplayView</code>。（如下图步骤 2）</li>
</ol>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-4.png" alt="图 4"></p>
<p>之后，我们运行程序，就可以看到，Hello World 出现在程序正中间了。如下图。</p>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-5.png" alt="图 5"></p>
<p>###代码解释</p>
<p>下面解释一下<code>drawRect</code>方法主要的步骤：</p>
<ol>
<li>得到当前绘制画布的上下文，用于后续将内容绘制在画布上。</li>
<li><p>将坐标系上下翻转。对于底层的绘制引擎来说，屏幕的左下角是（0, 0）坐标。而对于上层的 UIKit 来说，左上角是 (0, 0) 坐标。所以我们为了之后的坐标系描述按 UIKit 来做，所以先在这里做一个坐标系的上下翻转操作。翻转之后，底层和上层的 (0, 0) 坐标就是重合的了。</p>
<p>为了加深理解，我们将这部分的代码块注释掉，你会发现，整个<code>Hello World</code>界面将上下翻转，如下图所示。</p>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-flip.png" alt="图：上下翻转的界面"></p>
</li>
</ol>
<ol>
<li>创建绘制的区域，CoreText 本身支持各种文字排版的区域，我们这里简单地将 UIView 的整个界面作为排版的区域。</li>
</ol>
<p>为了加深理解，我们将该步骤的代码替换成如下代码，测试设置不同的绘制区域带来的界面变化。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// 步骤 3</div><div class="line">CGMutablePathRef path = CGPathCreateMutable();</div><div class="line">CGPathAddEllipseInRect(path, NULL, self.bounds);</div><div class="line"></div><div class="line">// 步骤 4</div><div class="line">NSAttributedString *attString = [[NSAttributedString alloc] initWithString:@&quot;Hello World! &quot;</div><div class="line">                                 &quot; 创建绘制的区域，CoreText 本身支持各种文字排版的区域，&quot;</div><div class="line">                                 &quot; 我们这里简单地将 UIView 的整个界面作为排版的区域。&quot;</div><div class="line">                                 &quot; 为了加深理解，建议读者将该步骤的代码替换成如下代码，&quot;</div><div class="line">                                 &quot; 测试设置不同的绘制区域带来的界面变化。&quot;];</div></pre></td></tr></table></figure>
<p>执行结果如下图所示：</p>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-shape.png" alt="图：椭圆形的排版区域"></p>
<h4 id="代码基本的宏定义和-Category"><a href="#代码基本的宏定义和-Category" class="headerlink" title="代码基本的宏定义和 Category"></a>代码基本的宏定义和 Category</h4><p>为了方便我们的代码编写，我在<code>CoreTextDemo-Prefix.pch</code>文件中增加了以下基本的宏定义，以方便我们使用 NSLog 和 UIColor。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">#ifdef DEBUG</div><div class="line">#define debugLog(...) NSLog(__VA_ARGS__)</div><div class="line">#define debugMethod() NSLog(@&quot;%s&quot;, __func__)</div><div class="line">#else</div><div class="line">#define debugLog(...)</div><div class="line">#define debugMethod()</div><div class="line">#endif</div><div class="line"></div><div class="line">#define RGB(A, B, C)    [UIColor colorWithRed:A/255.0 green:B/255.0 blue:C/255.0 alpha:1.0]</div></pre></td></tr></table></figure>
<p>我也为 UIView 的 frame 调整增加了一些扩展，可以方便地调整 UIView 的 x, y, width, height 等值。部分关键代码如下（完整的代码请查看示例工程）：</p>
<p>UIView+frameAdjust.h 文件:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line"></div><div class="line">@interface UIView (frameAdjust)</div><div class="line"></div><div class="line">- (CGFloat)x;</div><div class="line">- (void)setX:(CGFloat)x;</div><div class="line"></div><div class="line">- (CGFloat)y;</div><div class="line">- (void)setY:(CGFloat)y;</div><div class="line"></div><div class="line">- (CGFloat)height;</div><div class="line">- (void)setHeight:(CGFloat)height;</div><div class="line"></div><div class="line">- (CGFloat)width;</div><div class="line">- (void)setWidth:(CGFloat)width;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>UIView+frameAdjust.m 文件：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@implementation UIView (frameAdjust)</div><div class="line">- (CGFloat)x &#123;</div><div class="line">    return self.frame.origin.x;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)setX:(CGFloat)x &#123;</div><div class="line">    self.frame = CGRectMake(x, self.y, self.width, self.height);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (CGFloat)y &#123;</div><div class="line">    return self.frame.origin.y;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)setY:(CGFloat)y &#123;</div><div class="line">    self.frame = CGRectMake(self.x, y, self.width, self.height);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (CGFloat)height &#123;</div><div class="line">    return self.frame.size.height;</div><div class="line">&#125;</div><div class="line">- (void)setHeight:(CGFloat)height &#123;</div><div class="line">    self.frame = CGRectMake(self.x, self.y, self.width, height);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (CGFloat)width &#123;</div><div class="line">    return self.frame.size.width;</div><div class="line">&#125;</div><div class="line">- (void)setWidth:(CGFloat)width &#123;</div><div class="line">    self.frame = CGRectMake(self.x, self.y, width, self.height);</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>文章中的其余代码默认都#import 了以上提到的宏定义和 UIView Category。</p>
<h2 id="排版引擎框架"><a href="#排版引擎框架" class="headerlink" title="排版引擎框架"></a>排版引擎框架</h2><p>上面的 Hello World 工程仅仅展示了 Core Text 排版的基本能力。但是要制作一个较完善的排版引擎，我们不能简单的将所有代码都放到 <code>CTDisplayView</code> 的<code>drawRect</code>方法里面。根据设计模式中的 “ 单一功能原则 “(<code>Single responsibility principle</code>)，我们应该把功能拆分，把不同的功能都放到各自不同的类里面。</p>
<p>对于一个复杂的排版引擎来说，可以将其功能拆成以下几个类来完成：</p>
<ol>
<li>一个显示用的类，仅负责显示内容，不负责排版</li>
<li>一个模型类，用于承载显示所需要的所有数据</li>
<li>一个排版类，用于实现文字内容的排版</li>
<li>一个配置类，用于实现一些排版时的可配置项</li>
</ol>
<p>注：” 单一功能原则 “(<code>Single responsibility principle</code>)<br>参考链接：<a href="http://zh.wikipedia.org/wiki/%E5%8D%95%E4%B8%80%E5%8A%9F%E8%83%BD%E5%8E%9F%E5%88%99" target="_blank" rel="external">http://zh.wikipedia.org/wiki/%E5%8D%95%E4%B8%80%E5%8A%9F%E8%83%BD%E5%8E%9F%E5%88%99</a></p>
<p>按照以上原则，我们将<code>CTDisplayView</code>中的部分内容拆开，由 4 个类构成：</p>
<ol>
<li><code>CTFrameParserConfig</code>类，用于配置绘制的参数，例如：文字颜色，大小，行间距等。</li>
<li><code>CTFrameParser</code>类，用于生成最后绘制界面需要的<code>CTFrameRef</code>实例。</li>
<li><code>CoreTextData</code>类，用于保存由<code>CTFrameParser</code>类生成的<code>CTFrameRef</code>实例以及<code>CTFrameRef</code>实际绘制需要的高度。</li>
<li><code>CTDisplayView</code>类，持有<code>CoreTextData</code>类的实例，负责将<code>CTFrameRef</code>绘制到界面上。</li>
</ol>
<p>关于这 4 个类的关键代码如下：</p>
<p><code>CTFrameParserConfig</code>类:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line">@interface CTFrameParserConfig : NSObject</div><div class="line"></div><div class="line">@property (nonatomic, assign) CGFloat width;</div><div class="line">@property (nonatomic, assign) CGFloat fontSize;</div><div class="line">@property (nonatomic, assign) CGFloat lineSpace;</div><div class="line">@property (nonatomic, strong) UIColor *textColor;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">#import &quot;CTFrameParserConfig.h&quot;</div><div class="line"></div><div class="line">@implementation CTFrameParserConfig</div><div class="line"></div><div class="line">- (id)init &#123;</div><div class="line">    self = [super init];</div><div class="line">    if (self) &#123;</div><div class="line">        _width = 200.0f;</div><div class="line">        _fontSize = 16.0f;</div><div class="line">        _lineSpace = 8.0f;</div><div class="line">        _textColor = RGB(108, 108, 108);</div><div class="line">    &#125;</div><div class="line">    return self;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p><code>CTFrameParser</code>类:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line">#import &quot;CoreTextData.h&quot;</div><div class="line">#import &quot;CTFrameParserConfig.h&quot;</div><div class="line"></div><div class="line">@interface CTFrameParser : NSObject</div><div class="line"></div><div class="line">+ (CoreTextData *)parseContent:(NSString *)content config:(CTFrameParserConfig*)config;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">#import &quot;CTFrameParser.h&quot;</div><div class="line">#import &quot;CTFrameParserConfig.h&quot;</div><div class="line"></div><div class="line">@implementation CTFrameParser</div><div class="line"></div><div class="line">+ (NSDictionary *)attributesWithConfig:(CTFrameParserConfig *)config &#123;</div><div class="line">    CGFloat fontSize = config.fontSize;</div><div class="line">    CTFontRef fontRef = CTFontCreateWithName((CFStringRef)@&quot;ArialMT&quot;, fontSize, NULL);</div><div class="line">    CGFloat lineSpacing = config.lineSpace;</div><div class="line">    const CFIndex kNumberOfSettings = 3;</div><div class="line">    CTParagraphStyleSetting theSettings[kNumberOfSettings] = &#123;</div><div class="line">        &#123; kCTParagraphStyleSpecifierLineSpacingAdjustment, sizeof(CGFloat), &amp;lineSpacing &#125;,</div><div class="line">        &#123; kCTParagraphStyleSpecifierMaximumLineSpacing, sizeof(CGFloat), &amp;lineSpacing &#125;,</div><div class="line">        &#123; kCTParagraphStyleSpecifierMinimumLineSpacing, sizeof(CGFloat), &amp;lineSpacing &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    CTParagraphStyleRef theParagraphRef = CTParagraphStyleCreate(theSettings, kNumberOfSettings);</div><div class="line"></div><div class="line">    UIColor * textColor = config.textColor;</div><div class="line"></div><div class="line">    NSMutableDictionary * dict = [NSMutableDictionary dictionary];</div><div class="line">    dict[(id)kCTForegroundColorAttributeName] = (id)textColor.CGColor;</div><div class="line">    dict[(id)kCTFontAttributeName] = (__bridge id)fontRef;</div><div class="line">    dict[(id)kCTParagraphStyleAttributeName] = (__bridge id)theParagraphRef;</div><div class="line"></div><div class="line">    CFRelease(theParagraphRef);</div><div class="line">    CFRelease(fontRef);</div><div class="line">    return dict;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (CoreTextData *)parseContent:(NSString *)content config:(CTFrameParserConfig*)config &#123;</div><div class="line">    NSDictionary *attributes = [self attributesWithConfig:config];</div><div class="line">    NSAttributedString *contentString =</div><div class="line">        [[NSAttributedString alloc] initWithString:content</div><div class="line">                                        attributes:attributes];</div><div class="line"></div><div class="line">    // 创建 CTFramesetterRef 实例</div><div class="line">    CTFramesetterRef framesetter = CTFramesetterCreateWithAttributedString((CFAttributedStringRef)contentString);</div><div class="line"></div><div class="line">    // 获得要绘制的区域的高度</div><div class="line">    CGSize restrictSize = CGSizeMake(config.width, CGFLOAT_MAX);</div><div class="line">    CGSize coreTextSize = CTFramesetterSuggestFrameSizeWithConstraints(framesetter, CFRangeMake(0,0), nil, restrictSize, nil);</div><div class="line">    CGFloat textHeight = coreTextSize.height;</div><div class="line"></div><div class="line">    // 生成 CTFrameRef 实例</div><div class="line">    CTFrameRef frame = [self createFrameWithFramesetter:framesetter config:config height:textHeight];</div><div class="line"></div><div class="line">    // 将生成好的 CTFrameRef 实例和计算好的绘制高度保存到 CoreTextData 实例中，最后返回 CoreTextData 实例</div><div class="line">    CoreTextData *data = [[CoreTextData alloc] init];</div><div class="line">    data.ctFrame = frame;</div><div class="line">    data.height = textHeight;</div><div class="line"></div><div class="line">    // 释放内存</div><div class="line">    CFRelease(frame);</div><div class="line">    CFRelease(framesetter);</div><div class="line">    return data;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (CTFrameRef)createFrameWithFramesetter:(CTFramesetterRef)framesetter</div><div class="line">                                  config:(CTFrameParserConfig *)config</div><div class="line">                                  height:(CGFloat)height &#123;</div><div class="line"></div><div class="line">    CGMutablePathRef path = CGPathCreateMutable();</div><div class="line">    CGPathAddRect(path, NULL, CGRectMake(0, 0, config.width, height));</div><div class="line"></div><div class="line">    CTFrameRef frame = CTFramesetterCreateFrame(framesetter, CFRangeMake(0, 0), path, NULL);</div><div class="line">    CFRelease(path);</div><div class="line">    return frame;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p><code>CoreTextData</code>类:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line"></div><div class="line">@interface CoreTextData : NSObject</div><div class="line"></div><div class="line">@property (assign, nonatomic) CTFrameRef ctFrame;</div><div class="line">@property (assign, nonatomic) CGFloat height;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#import &quot;CoreTextData.h&quot;</div><div class="line"></div><div class="line">@implementation CoreTextData</div><div class="line"></div><div class="line">- (void)setCtFrame:(CTFrameRef)ctFrame &#123;</div><div class="line">    if (_ctFrame != ctFrame) &#123;</div><div class="line">        if (_ctFrame != nil) &#123;</div><div class="line">            CFRelease(_ctFrame);</div><div class="line">        &#125;</div><div class="line">        CFRetain(ctFrame);</div><div class="line">        _ctFrame = ctFrame;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)dealloc &#123;</div><div class="line">    if (_ctFrame != nil) &#123;</div><div class="line">        CFRelease(_ctFrame);</div><div class="line">        _ctFrame = nil;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p><code>CTDisplayView</code>类：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line">#import &quot;CoreTextData.h&quot;</div><div class="line"></div><div class="line">@interface CTDisplayView : UIView</div><div class="line"></div><div class="line">@property (strong, nonatomic) CoreTextData * data;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#import &quot;CTDisplayView.h&quot;</div><div class="line"></div><div class="line">@implementation CTDisplayView</div><div class="line"></div><div class="line">- (void)drawRect:(CGRect)rect</div><div class="line">&#123;</div><div class="line">    [super drawRect:rect];</div><div class="line">    CGContextRef context = UIGraphicsGetCurrentContext();</div><div class="line">    CGContextSetTextMatrix(context, CGAffineTransformIdentity);</div><div class="line">    CGContextTranslateCTM(context, 0, self.bounds.size.height);</div><div class="line">    CGContextScaleCTM(context, 1.0, -1.0);</div><div class="line"></div><div class="line">    if (self.data) &#123;</div><div class="line">        CTFrameDraw(self.data.ctFrame, context);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>以上 4 个类中的逻辑与之前 Hello World 那个项目的逻辑基本一致，只是分拆到了 4 个类中完成。另外，CTFrameParser 增加了方法来获得要绘制的区域的高度，并将高度信息保存到<code>CoreTextData</code>类的实例中。之所以要获得绘制区域的高度，是因为在很多实际使用场景中，我们需要先知道所要显示内容的高度，之后才可以进行绘制。</p>
<p>例如，在 UITableView 在渲染时，UITableView 首先会向 delegate 回调如下方法来获得每个将要渲染的 cell 的高度：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath;</div></pre></td></tr></table></figure>
<p>之后，UITableView 会计算当前滚动的位置具体需要绘制的 UITableViewCell 是哪些，然后对于那些需要绘制的 Cell，UITableView 才会继续向其 data source 回调如下方法来获得 UITableViewCell 实例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">- (UITableViewCell *)cellForRowAtIndexPath:(NSIndexPath *)indexPath;</div></pre></td></tr></table></figure>
<p>对于上面的情况，如果我们使用 CoreText 来作为 TableViewCell 的内容，那么就必须在每个 Cell 绘制之前，就知道其需要的绘制高度，否则 UITableView 将无法正常工作。</p>
<p>完成以上 4 个类之后，我们就可以简单地在<code>ViewController.m</code>文件中，加入如下代码来配置<code>CTDisplayView</code>的显示内容，位置，高度，字体，颜色等信息。代码如下所示。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#import &quot;ViewController.h&quot;</div><div class="line"></div><div class="line">@interface ViewController ()</div><div class="line"></div><div class="line">@property (weak, nonatomic) IBOutlet CTDisplayView *ctView;</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">@implementation ViewController</div><div class="line"></div><div class="line">- (void)viewDidLoad</div><div class="line">&#123;</div><div class="line">    [super viewDidLoad];</div><div class="line"></div><div class="line">    CTFrameParserConfig *config = [[CTFrameParserConfig alloc] init];</div><div class="line">    config.textColor = [UIColor redColor];</div><div class="line">    config.width = self.ctView.width;</div><div class="line"></div><div class="line">    CoreTextData *data = [CTFrameParser parseContent:@&quot; 按照以上原则，我们将`CTDisplayView`中的部分内容拆开。&quot; config:config];</div><div class="line">    self.ctView.data = data;</div><div class="line">    self.ctView.height = data.height;</div><div class="line">    self.ctView.backgroundColor = [UIColor yellowColor];</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>注意：从 Xcode4.0 开始，默认的界面编辑就开启了对于<code>Use Autolayout</code>的使用，但因为我们在代码中直接修改了变量<code>ctView</code>的 frame 信息，所以需要在<code>Main_iPhone.storyboard</code>中将<code>Use Autolayout</code>这一项取消勾选。如下图所示：</p>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-un-select-autolayout.png" alt="图：取消勾选 Autolayout"></p>
<p>以下是本框架的 UML 示意图，从图中我们可以看出，这 4 个 Core Text 类的关系是这样的：</p>
<ol>
<li><code>CTFrameParser</code>通过<code>CTFrameparserConfig</code>实例来生成<code>CoreTextData</code>实例。</li>
<li><code>CTDisplayView</code>通过持有<code>CoreTextData</code>实例来获得绘制所需要的所有信息。</li>
<li><code>ViewController</code>类通过配置<code>CTFrameparserConfig</code>实例，进而获得生成的<code>CoreTextData</code>实例，最后将其赋值给他的<code>CTDisplayView</code>成员，达到将指定内容显示在界面上的效果。</li>
</ol>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-uml.png" alt="图：UML 示意图"></p>
<p>说明 1：整个工程代码在名为<code>basic_arch</code>的分支下，读者可以在示例的源代码工程中使用<code>git checkout basic_arch</code>来切换到当前讲解的工程示例代码。</p>
<p>说明 2：为了方便操作<code>UIView</code>的<code>frame</code>属性，项目中增加了一个名为<code>UIView+frameAdjust.m</code>文件，它通过<code>Category</code>来给<code>UIView</code>增加了直接设置<code>height</code>属性的方法。</p>
<h2 id="定制排版文件格式"><a href="#定制排版文件格式" class="headerlink" title="定制排版文件格式"></a>定制排版文件格式</h2><p>对于上面的例子，我们给 CTFrameParser 使增加了一个将 NSString 转换为 CoreTextData 的方法。但这样的实现方式有很多局限性，因为整个内容虽然可以定制字体大小，颜色，行高等信息，但是却不能支持定制内容中的某一部分。例如，如果我们只想让内容的前三个字显示成红色，而其它文字显示成黑色，那么就办不到了。</p>
<p>解决的办法很简单，我们让<code>CTFrameParser</code>支持接受 NSAttributeString 作为参数，然后在<code>ViewController</code>类中设置我们想要的 NSAttributeString 信息。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@implementation ViewController</div><div class="line"></div><div class="line">- (void)viewDidLoad</div><div class="line">&#123;</div><div class="line">    [super viewDidLoad];</div><div class="line"></div><div class="line">    CTFrameParserConfig *config = [[CTFrameParserConfig alloc] init];</div><div class="line">    config.width = self.ctView.width;</div><div class="line">    config.textColor = [UIColor blackColor];</div><div class="line"></div><div class="line">    NSString *content =</div><div class="line">        @&quot; 对于上面的例子，我们给 CTFrameParser 增加了一个将 NSString 转 &quot;</div><div class="line">         &quot; 换为 CoreTextData 的方法。&quot;</div><div class="line">         &quot; 但这样的实现方式有很多局限性，因为整个内容虽然可以定制字体 &quot;</div><div class="line">         &quot; 大小，颜色，行高等信息，但是却不能支持定制内容中的某一部分。&quot;</div><div class="line">         &quot; 例如，如果我们只想让内容的前三个字显示成红色，而其它文字显 &quot;</div><div class="line">         &quot; 示成黑色，那么就办不到了。&quot;</div><div class="line">         &quot;\n\n&quot;</div><div class="line">         &quot; 解决的办法很简单，我们让`CTFrameParser`支持接受 &quot;</div><div class="line">         &quot;NSAttributeString 作为参数，然后在 NSAttributeString 中设置好 &quot;</div><div class="line">         &quot; 我们想要的信息。&quot;;</div><div class="line">    NSDictionary *attr = [CTFrameParser attributesWithConfig:config];</div><div class="line">    NSMutableAttributedString *attributedString =</div><div class="line">         [[NSMutableAttributedString alloc] initWithString:content</div><div class="line">                                                attributes:attr];</div><div class="line">    [attributedString addAttribute:NSForegroundColorAttributeName</div><div class="line">                             value:[UIColor redColor]</div><div class="line">                             range:NSMakeRange(0, 7)];</div><div class="line"></div><div class="line">    CoreTextData *data = [CTFrameParser parseAttributedContent:attributedString</div><div class="line">                                                        config:config];</div><div class="line">    self.ctView.data = data;</div><div class="line">    self.ctView.height = data.height;</div><div class="line">    self.ctView.backgroundColor = [UIColor yellowColor];</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>结果如下图所示，我们很方便就把前面 7 个字变成了红色。</p>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-attribute-string-as-argument.png" alt=""></p>
<p>更进一步地，实际工作中，我们更希望通过一个排版文件，来设置需要排版的文字的内容、颜色、字体大小等信息。我在开发猿题库应用时，自己定义了一个基于 UBB 的排版模版，但是实现该排版文件的解析器要花费大量的篇幅，考虑到这并不是本章的重点，所以我们以一个较简单的排版文件来讲解其思想。</p>
<p>我们规定排版的模版文件为 JSON 格式。JSON(JavaScript Object Notation) 是一种轻量级的数据交换格式，易于阅读和编写，同时也易于机器解析和生成。iOS 从 5.0 开始，提供了名为<code>NSJSONSerialization</code>的类库来方便开发者对 JSON 的解析。在 iOS5.0 之前，业界也有很多相关的 JSON 解析开源库，例如 JSONKit 可供大家使用。</p>
<p>我们的排版模版示例文件如下所示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[ &#123; &quot;color&quot; : &quot;blue&quot;,</div><div class="line">    &quot;content&quot; : &quot; 更进一步地，实际工作中，我们更希望通过一个排版文件，来设置需要排版的文字的 &quot;,</div><div class="line">    &quot;size&quot; : 16,</div><div class="line">    &quot;type&quot; : &quot;txt&quot;</div><div class="line">  &#125;,</div><div class="line">  &#123; &quot;color&quot; : &quot;red&quot;,</div><div class="line">    &quot;content&quot; : &quot; 内容、颜色、字体 &quot;,</div><div class="line">    &quot;size&quot; : 22,</div><div class="line">    &quot;type&quot; : &quot;txt&quot;</div><div class="line">  &#125;,</div><div class="line">  &#123; &quot;color&quot; : &quot;black&quot;,</div><div class="line">    &quot;content&quot; : &quot; 大小等信息。\n&quot;,</div><div class="line">    &quot;size&quot; : 16,</div><div class="line">    &quot;type&quot; : &quot;txt&quot;</div><div class="line">  &#125;,</div><div class="line">  &#123; &quot;color&quot; : &quot;default&quot;,</div><div class="line">    &quot;content&quot; : &quot; 我在开发猿题库应用时，自己定义了一个基于 UBB 的排版模版，但是实现该排版文件的解析器要花费大量的篇幅，考虑到这并不是本章的重点，所以我们以一个较简单的排版文件来讲解其思想。&quot;,</div><div class="line">    &quot;type&quot; : &quot;txt&quot;</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<p>通过苹果提供的<code>NSJSONSerialization</code>类，我们可以将上面的模版文件转换成 NSArray 数组，每一个数组元素是一个 NSDictionary，代表一段相同设置的文字。为了简单，我们的配置文件只支持配置颜色和字号，但是读者可以依据同样的思想，很方便地增加其它配置信息。</p>
<p>接下来我们要为<code>CTFrameParser</code>增加一个方法，让其可以从如上格式的模版文件中生成<code>CoreTextData</code>。最终我们的实现代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">// 方法一</div><div class="line">+ (CoreTextData *)parseTemplateFile:(NSString *)path config:(CTFrameParserConfig*)config &#123;</div><div class="line">    NSAttributedString *content = [self loadTemplateFile:path config:config];</div><div class="line">    return [self parseAttributedContent:content config:config];</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 方法二</div><div class="line">+ (NSAttributedString *)loadTemplateFile:(NSString *)path config:(CTFrameParserConfig*)config &#123;</div><div class="line">    NSData *data = [NSData dataWithContentsOfFile:path];</div><div class="line">    NSMutableAttributedString *result = [[NSMutableAttributedString alloc] init];</div><div class="line">    if (data) &#123;</div><div class="line">        NSArray *array = [NSJSONSerialization JSONObjectWithData:data</div><div class="line">                                           options:NSJSONReadingAllowFragments</div><div class="line">                                             error:nil];</div><div class="line">        if ([array isKindOfClass:[NSArray class]]) &#123;</div><div class="line">            for (NSDictionary *dict in array) &#123;</div><div class="line">                NSString *type = dict[@&quot;type&quot;];</div><div class="line">                if ([type isEqualToString:@&quot;txt&quot;]) &#123;</div><div class="line">                    NSAttributedString *as =</div><div class="line">                       [self parseAttributedContentFromNSDictionary:dict</div><div class="line">                                                             config:config];</div><div class="line">                    [result appendAttributedString:as];</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 方法三</div><div class="line">+ (NSAttributedString *)parseAttributedContentFromNSDictionary:(NSDictionary *)dict</div><div class="line">                                                        config:(CTFrameParserConfig*)config &#123;</div><div class="line">    NSMutableDictionary *attributes = [self attributesWithConfig:config];</div><div class="line">    // set color</div><div class="line">    UIColor *color = [self colorFromTemplate:dict[@&quot;color&quot;]];</div><div class="line">    if (color) &#123;</div><div class="line">        attributes[(id)kCTForegroundColorAttributeName] = (id)color.CGColor;</div><div class="line">    &#125;</div><div class="line">    // set font size</div><div class="line">    CGFloat fontSize = [dict[@&quot;size&quot;] floatValue];</div><div class="line">    if (fontSize &gt; 0) &#123;</div><div class="line">        CTFontRef fontRef = CTFontCreateWithName((CFStringRef)@&quot;ArialMT&quot;, fontSize, NULL);</div><div class="line">        attributes[(id)kCTFontAttributeName] = (__bridge id)fontRef;</div><div class="line">        CFRelease(fontRef);</div><div class="line">    &#125;</div><div class="line">    NSString *content = dict[@&quot;content&quot;];</div><div class="line">    return [[NSAttributedString alloc] initWithString:content attributes:attributes];</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 方法四</div><div class="line">+ (UIColor *)colorFromTemplate:(NSString *)name &#123;</div><div class="line">    if ([name isEqualToString:@&quot;blue&quot;]) &#123;</div><div class="line">        return [UIColor blueColor];</div><div class="line">    &#125; else if ([name isEqualToString:@&quot;red&quot;]) &#123;</div><div class="line">        return [UIColor redColor];</div><div class="line">    &#125; else if ([name isEqualToString:@&quot;black&quot;]) &#123;</div><div class="line">        return [UIColor blackColor];</div><div class="line">    &#125; else &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 方法五</div><div class="line">+ (CoreTextData *)parseAttributedContent:(NSAttributedString *)content config:(CTFrameParserConfig*)config &#123;</div><div class="line">    // 创建 CTFramesetterRef 实例</div><div class="line">    CTFramesetterRef framesetter = CTFramesetterCreateWithAttributedString((CFAttributedStringRef)content);</div><div class="line"></div><div class="line">    // 获得要缓制的区域的高度</div><div class="line">    CGSize restrictSize = CGSizeMake(config.width, CGFLOAT_MAX);</div><div class="line">    CGSize coreTextSize = CTFramesetterSuggestFrameSizeWithConstraints(framesetter, CFRangeMake(0,0), nil, restrictSize, nil);</div><div class="line">    CGFloat textHeight = coreTextSize.height;</div><div class="line"></div><div class="line">    // 生成 CTFrameRef 实例</div><div class="line">    CTFrameRef frame = [self createFrameWithFramesetter:framesetter config:config height:textHeight];</div><div class="line"></div><div class="line">    // 将生成好的 CTFrameRef 实例和计算好的缓制高度保存到 CoreTextData 实例中，最后返回 CoreTextData 实例</div><div class="line">    CoreTextData *data = [[CoreTextData alloc] init];</div><div class="line">    data.ctFrame = frame;</div><div class="line">    data.height = textHeight;</div><div class="line"></div><div class="line">    // 释放内存</div><div class="line">    CFRelease(frame);</div><div class="line">    CFRelease(framesetter);</div><div class="line">    return data;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 方法六</div><div class="line">+ (CTFrameRef)createFrameWithFramesetter:(CTFramesetterRef)framesetter</div><div class="line">                                  config:(CTFrameParserConfig *)config</div><div class="line">                                  height:(CGFloat)height &#123;</div><div class="line"></div><div class="line">    CGMutablePathRef path = CGPathCreateMutable();</div><div class="line">    CGPathAddRect(path, NULL, CGRectMake(0, 0, config.width, height));</div><div class="line"></div><div class="line">    CTFrameRef frame = CTFramesetterCreateFrame(framesetter, CFRangeMake(0, 0), path, NULL);</div><div class="line">    CFRelease(path);</div><div class="line">    return frame;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上代码主要由 6 个子方法构成：</p>
<ul>
<li>方法一用于提供对外的接口，调用方法二实现从一个 JSON 的模版文件中读取内容，然后调用方法五生成<code>CoreTextData</code>。</li>
<li>方法二读取 JSON 文件内容，并且调用方法三获得从<code>NSDictionary</code>到<code>NSAttributedString</code>的转换结果。</li>
<li>方法三将<code>NSDictionary</code>内容转换为<code>NSAttributedString</code>。</li>
<li>方法四提供将<code>NSString</code>转为<code>UIColor</code>的功能。</li>
<li>方法五接受一个<code>NSAttributedString</code>和一个<code>config</code>参数，将<code>NSAttributedString</code>转换成<code>CoreTextData</code>返回。</li>
<li>方法六是方法五的一个辅助函数，供方法五调用。</li>
</ul>
<p>然后我们将<code>ViewController</code>中的调用代码作一下更改，使其从模版文件中加载内容，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">@implementation ViewController</div><div class="line"></div><div class="line">- (void)viewDidLoad</div><div class="line">&#123;</div><div class="line">    [super viewDidLoad];</div><div class="line"></div><div class="line">    CTFrameParserConfig *config = [[CTFrameParserConfig alloc] init];</div><div class="line">    config.width = self.ctView.width;</div><div class="line">    NSString *path = [[NSBundle mainBundle] pathForResource:@&quot;content&quot; ofType:@&quot;json&quot;];</div><div class="line">    CoreTextData *data = [CTFrameParser parseTemplateFile:path config:config];</div><div class="line">    self.ctView.data = data;</div><div class="line">    self.ctView.height = data.height;</div><div class="line">    self.ctView.backgroundColor = [UIColor whiteColor];</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>最后运行得到的结果如下所示，可以看到，通过一个简单的模板文件，我们已经可以很方便地定义排版的配置信息了。</p>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-load-from-json-template.png" alt=""></p>
<p>说明：读者可以在示例工程中使用<code>git checkout json_template</code>，查看可以运行的示例代码。</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/iOS/">iOS</a>
</div>


</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://blog.devtang.com/2015/06/27/using-coretext-1/" data-title="基于 CoreText 的排版引擎：基础 | 唐巧的博客" data-tsina="undefined" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/06/27/using-coretext-2/" title="基于 CoreText 的排版引擎：进阶">
  <strong>上一篇：</strong><br/>
  <span>
  基于 CoreText 的排版引擎：进阶</span>
</a>
</div>


<div class="next">
<a href="/2015/06/16/talk-about-tech-interview/"  title="你会翻转二叉树吗？--谈程序员的招聘">
 <strong>下一篇：</strong><br/> 
 <span>你会翻转二叉树吗？--谈程序员的招聘
</span>
</a>
</div>

</nav>

	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  <div class="sponsor">
  <br />
  <p class="asidetitle">赞助商</p>
  <a target="_blank" href="https://www.boxueio.com/register/30b8aaac334ecfa97fe6937cc091aca6">
  <img src="http://wx1.sinaimg.cn/large/65dc76a3ly1fduudtak0zj206j05kglq.jpg" width="235px" height="200px" />
  </a>
  <br /><br /><a href="/sponsor">
  <font color="#2ca6cb" style="
    font-size: 14px;
    text-align: right;
">购买广告位</font></a>
</div>


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
		
		  
			<li><a href="/categories/books-summary/" title="books summary">books summary</a></li>
		  
		
		  
			<li><a href="/categories/iOS/" title="iOS">iOS</a></li>
		  
		
		  
			<li><a href="/categories/iOS-weekly/" title="iOS weekly">iOS weekly</a></li>
		  
		
		  
			<li><a href="/categories/mac/" title="mac">mac</a></li>
		  
		
		  
			<li><a href="/categories/shell/" title="shell">shell</a></li>
		  
		
		  
			<li><a href="/categories/summary/" title="summary">summary</a></li>
		  
		
		  
		
		  
		
		</ul>
</div>


  <div class="weixin">
  <br />
  <p class="asidetitle">微信公众号</p>
  <p>关注我的微信公众号，和我一起成长：</p>
  <img src="http://ww4.sinaimg.cn/mw690/65dc76a3jw1f1ngaau9arj20760763yr.jpg" width="230px" />
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

	<p class="copyright" style="margin-top: 10px;">
	Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2017
	
	<a href="/about" target="_blank" title="唐巧">唐巧</a>
	

	</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>











<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-28029597-1', 'null');  
ga('send', 'pageview');
</script>





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
